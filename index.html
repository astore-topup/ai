
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KRL Tracker Jogja ‚Äì Palur</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .navbar {
      background-color: #c62828;
      color: white;
      padding: 12px 16px;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-panel {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      background-color: white;
      padding: 10px;
      font-size: 15px;
      border-bottom: 1px solid #ddd;
    }

    .info-panel div {
      margin: 5px 10px;
    }

    #map {
      flex-grow: 1;
      width: 100%;
    }

    .status {
      text-align: center;
      font-size: 0.9em;
      color: #666;
      padding: 6px;
    }

    .locate-btn {
      position: absolute;
      bottom: 20px;
      left: 15px;
      z-index: 1000;
      background-color: white;
      border: 2px solid #c62828;
      color: #c62828;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .krl-label-box {
      background-color: rgba(255, 255, 255, 0.9);
      padding: 4px 8px;
      border-radius: 8px;
      border: 2px solid red;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-weight: bold;
      color: red;
      font-size: 14px;
      text-align: center;
      line-height: 1.2;
    }
  </style>
</head>
<body>
  <div class="navbar">
    üöÜ KRL Yogyakarta ‚Äì Palur
    <span id="statusKereta">Status: -</span>
  </div>

  <div class="info-panel">
    <div>üå°Ô∏è Suhu: <span id="temp">-</span> ¬∞C</div>
    <div>üöÜ Kecepatan: <span id="speed">0</span> km/jam</div>
    <div>üìç Stasiun berikutnya: <span id="nextStation">-</span></div>
    <div>üìè Jarak: <span id="distanceToNext">-</span> km</div>
  </div>

  <button class="locate-btn" onclick="zoomToUser()">üìç Lokasi Saya</button>
  <div id="map"></div>
  <div class="status" id="status">Menunggu GPS...</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const speedEl = document.getElementById("speed");
    const statusEl = document.getElementById("status");
    const nextStationEl = document.getElementById("nextStation");
    const distanceEl = document.getElementById("distanceToNext");
    const tempEl = document.getElementById("temp");
    const statusKeretaEl = document.getElementById("statusKereta");

    const stations = [
      { name: "Yogyakarta", lat: -7.7894, lon: 110.3630 },
      { name: "Lempuyangan", lat: -7.7829, lon: 110.3794 },
      { name: "Maguwo", lat: -7.7833, lon: 110.4253 },
      { name: "Brambanan", lat: -7.7545, lon: 110.4912 },
      { name: "Srowot", lat: -7.7265, lon: 110.5401 },
      { name: "Klaten", lat: -7.7058, lon: 110.6060 },
      { name: "Delanggu", lat: -7.6586, lon: 110.6803 },
      { name: "Gawok", lat: -7.6063, lon: 110.7637 },
      { name: "Purwosari", lat: -7.5671, lon: 110.7924 },
      { name: "Solo Balapan", lat: -7.5611, lon: 110.8226 },
      { name: "Palur", lat: -7.5524, lon: 110.8843 }
    ];

    let map, marker;
    let currentLat = null;
    let currentLon = null;

    const trainLabelIcon = L.divIcon({
      html: '<div class="krl-label-box">üöÜ KRL Commuter<br>Yogyakarta‚ÄìPalur</div>',
      className: '',
      iconSize: [160, 50],
      iconAnchor: [80, 25]
    });

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function findNextStation(lat, lon) {
      let closest = null;
      let minDist = Infinity;
      for (const station of stations) {
        const dist = getDistance(lat, lon, station.lat, station.lon);
        if (dist < minDist && dist > 0.3) {
          minDist = dist;
          closest = station;
        }
      }
      return { station: closest, distance: minDist.toFixed(2) };
    }

    function addStationMarkers() {
      for (const s of stations) {
        L.circleMarker([s.lat, s.lon], {
          radius: 5,
          color: 'blue'
        }).addTo(map).bindPopup(s.name);
      }
    }

    function initMap(lat, lon) {
      map = L.map('map').setView([lat, lon], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([lat, lon], { icon: trainLabelIcon }).addTo(map);
      addStationMarkers();

      // Gesture double tap zoom to user
      let lastTap = 0;
      map.getContainer().addEventListener("touchend", function(e) {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 500 && tapLength > 0) {
          zoomToUser();
        }
        lastTap = currentTime;
      });
    }

    function zoomToUser() {
      if (map && currentLat && currentLon) {
        map.setView([currentLat, currentLon], 15);
      }
    }

    if ("geolocation" in navigator) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          currentLat = lat;
          currentLon = lon;

          const speedMps = pos.coords.speed;

          if (!map) initMap(lat, lon);
          if (marker) {
            marker.setLatLng([lat, lon]);
            map.panTo([lat, lon]);
          }

          if (speedMps !== null) {
            const kmph = (speedMps * 3.6).toFixed(1);
            speedEl.textContent = kmph;
            statusEl.textContent = "GPS aktif";

            statusKeretaEl.textContent = speedMps > 1 ? "Status: Berjalan" : "Status: Berhenti";
          }

          const { station, distance } = findNextStation(lat, lon);
          if (station) {
            nextStationEl.textContent = station.name;
            distanceEl.textContent = distance;
          }
        },
        (err) => {
          statusEl.textContent = "Lokasi tidak tersedia.";
          console.error(err);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000
        }
      );
    } else {
      statusEl.textContent = "Geolocation tidak didukung.";
    }

    function getTemperature() {
      tempEl.textContent = "N/A"; // Placeholder
    }

    getTemperature();
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KRL Tracker Jogja ‚Äì Palur (Arah Dinamis)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .navbar {
      background-color: #c62828;
      color: white;
      padding: 12px 16px;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-panel {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      background-color: white;
      padding: 10px;
      font-size: 15px;
      border-bottom: 1px solid #ddd;
    }

    .info-panel div {
      margin: 5px 10px;
    }

    #map {
      flex-grow: 1;
      width: 100%;
    }

    .status {
      text-align: center;
      font-size: 0.9em;
      color: #666;
      padding: 6px;
    }

    .locate-btn {
      position: absolute;
      bottom: 20px;
      left: 15px;
      z-index: 1000;
      background-color: white;
      border: 2px solid #c62828;
      color: #c62828;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .krl-label-box {
      background-color: rgba(255, 255, 255, 0.9);
      padding: 4px 8px;
      border-radius: 8px;
      border: 2px solid red;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-weight: bold;
      color: red;
      font-size: 14px;
      text-align: center;
      line-height: 1.2;
    }
  </style>
</head>
<body>
  <div class="navbar">
    üöÜ KRL Yogyakarta ‚Äì Palur
    <span id="statusKereta">Status: -</span>
  </div>

  <div class="info-panel">
    <div>üå°Ô∏è Suhu: <span id="temp">-</span> ¬∞C</div>
    <div>üöÜ Kecepatan: <span id="speed">0</span> km/jam</div>
    <div>üìç Stasiun berikutnya: <span id="nextStation">-</span></div>
    <div>üìè Jarak: <span id="distanceToNext">-</span> km</div>
  </div>

  <button class="locate-btn" onclick="zoomToUser()">üìç Lokasi Saya</button>
  <div id="map"></div>
  <div class="status" id="status">Menunggu GPS...</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const speedEl = document.getElementById("speed");
    const statusEl = document.getElementById("status");
    const nextStationEl = document.getElementById("nextStation");
    const distanceEl = document.getElementById("distanceToNext");
    const tempEl = document.getElementById("temp");
    const statusKeretaEl = document.getElementById("statusKereta");

    const stations = [{"name": "Yogyakarta", "lat": -7.7894, "lon": 110.363}, {"name": "Lempuyangan", "lat": -7.7829, "lon": 110.3794}, {"name": "Maguwo", "lat": -7.7833, "lon": 110.4253}, {"name": "Brambanan", "lat": -7.7545, "lon": 110.4912}, {"name": "Srowot", "lat": -7.7265, "lon": 110.5401}, {"name": "Klaten", "lat": -7.7058, "lon": 110.606}, {"name": "Ceper", "lat": -7.6783, "lon": 110.6453}, {"name": "Delanggu", "lat": -7.6586, "lon": 110.6803}, {"name": "Gawok", "lat": -7.59736, "lon": 110.7381}, {"name": "Purwosari", "lat": -7.5671, "lon": 110.7924}, {"name": "Solo Balapan", "lat": -7.5611, "lon": 110.8226}, {"name": "Solo Jebres", "lat": -7.5586, "lon": 110.8496}, {"name": "Palur", "lat": -7.5524, "lon": 110.8843}];

    let map, marker;
    let currentLat = null;
    let currentLon = null;
    let prevLat = null;
    let prevLon = null;

    const trainLabelIcon = L.divIcon({
      html: '<div class="krl-label-box">üöÜ KRL Commuter<br>Yogyakarta‚ÄìPalur</div>',
      className: '',
      iconSize: [160, 50],
      iconAnchor: [80, 25]
    });

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function getBearing(lat1, lon1, lat2, lon2) {
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
      const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
      const brng = Math.atan2(y, x) * 180 / Math.PI;
      return (brng + 360) % 360;
    }

    function findNextStationDirectional(lat, lon, bearing) {
      let next = null;
      let minDist = Infinity;
      const isEastward = bearing > 90 && bearing < 270;

      const orderedStations = isEastward ? stations : [...stations].reverse();

      for (const s of orderedStations) {
        const dist = getDistance(lat, lon, s.lat, s.lon);
        const dLat = s.lat - lat;
        if (dist < minDist && dist > 0.2 && ((isEastward && dLat < 0.5) || (!isEastward && dLat > -0.5))) {
          minDist = dist;
          next = s;
        }
      }
      return { station: next, distance: minDist.toFixed(2) };
    }

    function addStationMarkers() {
      for (const s of stations) {
        L.circleMarker([s.lat, s.lon], {
          radius: 5,
          color: 'blue'
        }).addTo(map).bindPopup(s.name);
      }
    }

    function initMap(lat, lon) {
      map = L.map('map').setView([lat, lon], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([lat, lon], { icon: trainLabelIcon }).addTo(map);
      addStationMarkers();

      let lastTap = 0;
      map.getContainer().addEventListener("touchend", function(e) {
        const currentTime = new Date().getTime();
        if (currentTime - lastTap < 500) {
          zoomToUser();
        }
        lastTap = currentTime;
      });
    }

    function zoomToUser() {
      if (map && currentLat && currentLon) {
        map.setView([currentLat, currentLon], 15);
      }
    }

    if ("geolocation" in navigator) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const speedMps = pos.coords.speed;

          prevLat = currentLat;
          prevLon = currentLon;

          currentLat = lat;
          currentLon = lon;

          if (!map) initMap(lat, lon);
          if (marker) {
            marker.setLatLng([lat, lon]);
            map.panTo([lat, lon]);
          }

          if (speedMps !== null) {
            const kmph = (speedMps * 3.6).toFixed(1);
            speedEl.textContent = kmph;
            statusEl.textContent = "GPS aktif";
            
    if (speedMps > 1) {
      statusKeretaEl.textContent = "Status: Berjalan";
    } else {
      let stopStation = null;
      for (const s of stations) {
        const d = getDistance(lat, lon, s.lat, s.lon);
        if (d < 0.3) {
          stopStation = s.name;
          break;
        }
      }
      if (stopStation) {
        statusKeretaEl.textContent = "Status: Berhenti di " + stopStation;
      } else {
        statusKeretaEl.textContent = "Status: Berhenti";
      }
    }
    
          }

          if (prevLat !== null && prevLon !== null) {
            const bearing = getBearing(prevLat, prevLon, lat, lon);
            const { station, distance } = findNextStationDirectional(lat, lon, bearing);
            if (station) {
              nextStationEl.textContent = station.name;
              distanceEl.textContent = distance;
            }
          }
        },
        (err) => {
          statusEl.textContent = "Lokasi tidak tersedia.";
          console.error(err);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000
        }
      );
    } else {
      statusEl.textContent = "Geolocation tidak didukung.";
    }

    function getTemperature() {
      tempEl.textContent = "N/A";
    }

    getTemperature();
  </script>
</body>
</html>

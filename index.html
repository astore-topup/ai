<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KRL Yogyakarta ‚Äì Palur Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 100vh; }
    .info-box {
      position: absolute;
      top: 0;
      width: 100%;
      background: #b71c1c;
      color: white;
      padding: 10px;
      font-weight: bold;
      text-align: center;
    }
    .data-bar {
      display: flex;
      justify-content: center;
      gap: 10px;
      background: white;
      color: black;
      padding: 8px;
      font-size: 15px;
      flex-wrap: wrap;
    }
    .lokasi-btn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 6px 12px;
      border-radius: 8px;
      border: 2px solid red;
      font-weight: bold;
    }
    .train-label {
      background: white;
      padding: 6px 12px;
      border: 2px solid red;
      border-radius: 8px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="info-box">üöÜ KRL Yogyakarta ‚Äì Palur &nbsp;&nbsp; <span id="status">Status: -</span></div>
  <div class="data-bar">
    <span>üå°Ô∏è Suhu: <span id="suhu">N/A</span> ¬∞C</span>
    <span>üöâ Kecepatan: <span id="speed">0</span> km/jam</span>
    <span>üìç Stasiun berikutnya: <span id="nextStation">-</span></span>
    <span>‚úèÔ∏è Jarak: <span id="jarak">-</span> km</span>
  </div>
  <div id="map"></div>
  <button class="lokasi-btn" onclick="zoomLokasi()">üìç Lokasi Saya</button>

<script>
const stations = [
  { "name": "Yogyakarta", "lat": -7.7896, "lon": 110.3671 },
  { "name": "Lempuyangan", "lat": -7.7828, "lon": 110.3794 },
  { "name": "Maguwo", "lat": -7.7833, "lon": 110.4083 },
  { "name": "Brambanan", "lat": -7.7551, "lon": 110.4549 },
  { "name": "Srowot", "lat": -7.7393, "lon": 110.4819 },
  { "name": "Klaten", "lat": -7.7058, "lon": 110.6063 },
  { "name": "Ceper", "lat": -7.7044, "lon": 110.6785 },
  { "name": "Delanggu", "lat": -7.6406, "lon": 110.6953 },
  { "name": "Gawok", "lat": -7.59736, "lon": 110.73810 },
  { "name": "Purwosari", "lat": -7.5656, "lon": 110.8017 },
  { "name": "Solo Balapan", "lat": -7.5562, "lon": 110.8251 },
  { "name": "Solo Jebres", "lat": -7.5525, "lon": 110.8494 },
  { "name": "Palur", "lat": -7.5412, "lon": 110.8784 }
];

function distance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

let directionForward = true;
let lastLatLng = null;
let currentLatLng = null;

function detectDirection(currentLatLngNew) {
  if (!lastLatLng) {
    lastLatLng = currentLatLngNew;
    return;
  }
  const start = stations[0];
  const end = stations[stations.length - 1];
  const dToStartNow = distance(currentLatLngNew.lat, currentLatLngNew.lng, start.lat, start.lon);
  const dToEndNow = distance(currentLatLngNew.lat, currentLatLngNew.lng, end.lat, end.lon);
  const dToStartLast = distance(lastLatLng.lat, lastLatLng.lng, start.lat, start.lon);
  const dToEndLast = distance(lastLatLng.lat, lastLatLng.lng, end.lat, end.lon);

  if ((dToEndNow < dToEndLast) && (dToStartNow > dToStartLast)) {
    directionForward = true;
  } else if ((dToStartNow < dToStartLast) && (dToEndNow > dToEndLast)) {
    directionForward = false;
  }
  lastLatLng = currentLatLngNew;
}

let map = L.map('map').setView([-7.65, 110.75], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let marker = L.marker([-7.65, 110.75]).addTo(map);
let label = L.popup({ closeButton: false })
  .setLatLng([-7.65, 110.75])
  .setContent('<div class="train-label">üöÜ KRL Commuter<br>Yogyakarta‚ÄìPalur</div>')
  .openOn(map);

function updatePosition(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const speed = (pos.coords.speed || 0) * 3.6;
  document.getElementById("speed").textContent = speed.toFixed(1);
  marker.setLatLng([lat, lon]);
  label.setLatLng([lat, lon]);
  currentLatLng = [lat, lon];

  detectDirection({ lat, lng: lon });

  const stationList = directionForward ? stations : [...stations].reverse();
  let minDist = Infinity;
  let nearest = null;

  for (let i = 0; i < stationList.length; i++) {
    const s = stationList[i];
    const d = distance(lat, lon, s.lat, s.lon);
    if (d < minDist) {
      minDist = d;
      nearest = s;
    }
    if (d < 0.3) {
      document.getElementById("status").textContent = "Status: Berhenti di stasiun " + s.name;
      document.getElementById("nextStation").textContent = s.name;
      document.getElementById("jarak").textContent = "0";
      return;
    }
  }

  const idx = stationList.indexOf(nearest);
  const nextStation = stationList[idx + 1];
  document.getElementById("status").textContent = "Status: Berjalan";
  document.getElementById("nextStation").textContent = nextStation ? nextStation.name : "-";
  if (nextStation) {
    const jarak = distance(lat, lon, nextStation.lat, nextStation.lon);
    document.getElementById("jarak").textContent = jarak.toFixed(2);
  } else {
    document.getElementById("jarak").textContent = "-";
  }
}

function zoomLokasi() {
  if (currentLatLng) {
    map.flyTo(currentLatLng, 16);
  }
}

if (navigator.geolocation) {
  navigator.geolocation.watchPosition(updatePosition);
}
</script>
</body>
</html>
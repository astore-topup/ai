<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>KRL Yogyakarta – Palur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 100%; }
    #panel {
      position: absolute;
      top: 0; left: 0; right: 0;
      background: #c62828;
      color: white;
      padding: 10px;
      font-size: 16px;
      z-index: 999;
      text-align: center;
    }
    .info {
      background: white;
      padding: 6px;
      font-size: 14px;
      color: black;
    }
    .train-label {
      font-weight: bold;
      font-size: 12px;
      text-align: center;
      color: black;
    }
    #control {
      background: #fff;
      padding: 8px;
    }
  </style>
</head>
<body>
  <div id="panel">
    🚆 <b>KRL Yogyakarta – Palur</b>
    <span id="status">Status: -</span>
  </div>

  <div id="control">
    <label for="arah">Pilih arah: </label>
    <select id="arah" onchange="gantiArah()">
      <option value="jogja-solo">Yogyakarta → Solo Balapan</option>
      <option value="solo-jogja">Solo Balapan → Yogyakarta</option>
    </select>
    <div class="info">
      🌡️ Suhu: N/A °C |
      🚆 Kecepatan: <span id="kecepatan">0</span> km/jam |
      📍 Stasiun berikutnya: <span id="nextStasiun">-</span> |
      ✏️ Jarak: <span id="jarak">-</span> km
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([-7.7, 110.4], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map by OpenStreetMap',
    }).addTo(map);

    const stasiunAsli = [
      { nama: "Yogyakarta", lat: -7.789352, lon: 110.363785 },
      { nama: "Lempuyangan", lat: -7.782889, lon: 110.379570 },
      { nama: "Maguwo", lat: -7.783100, lon: 110.420403 },
      { nama: "Brambanan", lat: -7.755048, lon: 110.488655 },
      { nama: "Srowot", lat: -7.738089, lon: 110.524731 },
      { nama: "Klaten", lat: -7.705940, lon: 110.606926 },
      { nama: "Ceper", lat: -7.704543, lon: 110.666372 },
      { nama: "Delanggu", lat: -7.672708, lon: 110.711602 },
      { nama: "Gawok", lat: -7.616038, lon: 110.748452 },
      { nama: "Purwosari", lat: -7.569504, lon: 110.801048 },
      { nama: "Solo Balapan", lat: -7.559601, lon: 110.831787 }
    ];

    let stasiun = [...stasiunAsli];
    let marker = null;
    let label = null;

    stasiun.forEach(s => {
      L.circleMarker([s.lat, s.lon], { radius: 5, color: 'red' }).addTo(map)
        .bindPopup("🚉 " + s.nama);
    });

    const garis = L.polyline(stasiun.map(s => [s.lat, s.lon]), { color: 'red' }).addTo(map);

    function gantiArah() {
      const arah = document.getElementById("arah").value;
      stasiun = (arah === "solo-jogja") ? [...stasiunAsli].reverse() : [...stasiunAsli];
      garis.setLatLngs(stasiun.map(s => [s.lat, s.lon]));
    }

    function hitungJarak(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateLokasi(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) : 0;
      document.getElementById("kecepatan").textContent = speed;

      if (!marker) {
        marker = L.marker([lat, lon]).addTo(map);
        label = L.marker([lat, lon], {
          icon: L.divIcon({
            className: 'train-label',
            html: '🚆 KRL Commuter<br>Yogyakarta–Palur'
          })
        }).addTo(map);
        map.setView([lat, lon], 15);
      } else {
        marker.setLatLng([lat, lon]);
        label.setLatLng([lat, lon]);
      }

      let indexTerdekat = -1;
      let minJarak = Infinity;

      for (let i = 0; i < stasiun.length; i++) {
        const jrk = hitungJarak(lat, lon, stasiun[i].lat, stasiun[i].lon);
        if (jrk < minJarak) {
          minJarak = jrk;
          indexTerdekat = i;
        }
      }

      const stasiunDekat = stasiun[indexTerdekat];
      const jarakKeStasiun = hitungJarak(lat, lon, stasiunDekat.lat, stasiunDekat.lon);

      if (jarakKeStasiun < 0.2 && speed < 5) {
        document.getElementById("status").textContent = `Status: Berhenti di stasiun ${stasiunDekat.nama}`;
        document.getElementById("nextStasiun").textContent = stasiunDekat.nama;
        document.getElementById("jarak").textContent = "0";
      } else {
        const next = stasiun[indexTerdekat + 1] ?? stasiun[indexTerdekat];
        const jarak = hitungJarak(lat, lon, next.lat, next.lon);
        document.getElementById("status").textContent = "Status: Berjalan";
        document.getElementById("nextStasiun").textContent = next.nama;
        document.getElementById("jarak").textContent = jarak.toFixed(2);
      }
    }

    function errorLokasi(err) {
      alert("Gagal mendapatkan lokasi: " + err.message);
    }

    navigator.geolocation.watchPosition(updateLokasi, errorLokasi, {
      enableHighAccuracy: true,
      maximumAge: 1000
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KRL Yogyakarta ‚Äì Palur Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    .header {
      background: #c62828; color: white;
      padding: 10px; font-weight: bold;
      text-align: center; font-size: 1.2em;
    }
    .info-bar {
      display: flex; flex-wrap: wrap;
      justify-content: center; gap: 10px;
      padding: 10px; font-size: 0.9em;
      background: #f9f9f9;
    }
    .lokasi-btn {
      background: white; color: red;
      padding: 6px 12px; border-radius: 8px;
      border: 2px solid red; cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      position: absolute; bottom: 20px; left: 20px; z-index: 999;
    }
    #map { height: 90vh; width: 100%; }
    .train-label {
      background: white; padding: 6px 12px;
      border-radius: 10px; border: 2px solid red;
      font-weight: bold; font-size: 0.9em;
      box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="header">
    üöÜ KRL Yogyakarta ‚Äì Palur¬†¬†<span id="status">Status: ‚Äî</span>
  </div>
  <div class="info-bar">
    üå°Ô∏è Suhu: <span id="suhu">N/A</span> ¬∞C
    üöâ Kecepatan: <span id="kecepatan">0</span> km/jam
    üìç Stasiun berikutnya: <span id="nextStasiun">-</span>
    ‚úèÔ∏è Jarak: <span id="jarak">-</span> km
  </div>
  <div id="map"></div>
  <button class="lokasi-btn" onclick="zoomLokasi()">üìç Lokasi Saya</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([-7.566, 110.818], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    const stasiun = [
      { nama: "Yogyakarta", lat: -7.789, lon: 110.364 },
      { nama: "Lempuyangan", lat: -7.782, lon: 110.379 },
      { nama: "Maguwo", lat: -7.782, lon: 110.422 },
      { nama: "Brambanan", lat: -7.755, lon: 110.489 },
      { nama: "Srowot", lat: -7.735, lon: 110.524 },
      { nama: "Klaten", lat: -7.704, lon: 110.607 },
      { nama: "Ceper", lat: -7.689, lon: 110.681 },
      { nama: "Delanggu", lat: -7.642, lon: 110.717 },
      { nama: "Gawok", lat: -7.595, lon: 110.764 },
      { nama: "Purwosari", lat: -7.562, lon: 110.801 },
      { nama: "Solo Balapan", lat: -7.556, lon: 110.825 },
      { nama: "Solo Jebres", lat: -7.552, lon: 110.852 },
      { nama: "Palur", lat: -7.541, lon: 110.881 },
    ];

    // Tambah garis lintasan merah
    const jalur = stasiun.map(s => [s.lat, s.lon]);
    L.polyline(jalur, { color: "red", weight: 4 }).addTo(map);

    let marker = null;
    let label = null;
    let currentLatLng = null;

    function hitungJarak(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function updateLokasi(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) : 0;
      document.getElementById("kecepatan").textContent = speed;

      currentLatLng = [lat, lon];
      if (!marker) {
        marker = L.marker([lat, lon]).addTo(map);
        label = L.marker([lat, lon], {
          icon: L.divIcon({
            className: 'train-label',
            html: 'üöÜ KRL Commuter<br>Yogyakarta‚ÄìPalur'
          })
        }).addTo(map);
      } else {
        marker.setLatLng([lat, lon]);
        label.setLatLng([lat, lon]);
      }

      const terdekat = stasiun.reduce((a, b) => {
        return hitungJarak(lat, lon, a.lat, a.lon) < hitungJarak(lat, lon, b.lat, b.lon) ? a : b;
      });
      const jarak = hitungJarak(lat, lon, terdekat.lat, terdekat.lon);
      if (jarak < 0.15 && speed < 5) {
        document.getElementById("status").textContent = `Status: Berhenti di stasiun ${terdekat.nama}`;
        document.getElementById("nextStasiun").textContent = terdekat.nama;
        document.getElementById("jarak").textContent = "0";
      } else {
        const sisa = stasiun.find(s => hitungJarak(lat, lon, s.lat, s.lon) > 0.15);
        document.getElementById("status").textContent = "Status: Berjalan";
        document.getElementById("nextStasiun").textContent = sisa ? sisa.nama : "-";
        document.getElementById("jarak").textContent = sisa ? hitungJarak(lat, lon, sisa.lat, sisa.lon).toFixed(2) : "-";
      }
    }

    function zoomLokasi() {
      if (currentLatLng) {
        map.flyTo(currentLatLng, 16);
      }
    }

    navigator.geolocation.watchPosition(updateLokasi, console.error, {
      enableHighAccuracy: true,
      maximumAge: 1000
    });
  </script>
</body>
</html>